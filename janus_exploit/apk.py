# Tento kód je součást diplomové práce "Využití zranitelnosti Janus na operačním systému Android"
# Autor: Bc. Vít Souček (soucevi1@fit.cvut.cz)
#
# Použité zdroje:
#     - Specifikace formátu souboru PKZip:
#         autor: Florian Buchholz (buchhofp@jmu.edu)
#         dostupné z: https://users.cs.jmu.edu/buchhofp/forensics/formats/pkzip.html
#         V komentářích v kódu referována pouze jako "dokumentace".

import struct


class Apk:
    """
    Třída představující soubor APK.
    """

    def __init__(self, data):
        """
        Třída obsahuje data APK souboru, konstanty PKZip (podle dokumentace),
        ofset počátku sekce Central Directory a ofset sekce End of the Central Directory.

        :param data: Data APK souboru
        :type data: bytearray
        """
        self.data = data
        self.FILE_HEADER_SIGNATURE = b'PK\x01\x02'
        self.END_OF_CENTRAL_DIRECTORY_SIGNATURE = b'PK\x05\x06'
        self.end_of_central_directory = self.get_end_of_central_directory()
        self.cd_start = self.get_central_directory_start()

    def get_end_of_central_directory(self):
        """
        Nalezne sekci End of the Central Directory
        podle signatury z PKZip dokumentace (PK\x05\x06).

        :return: Ofset sekce End of the Central Directory v APK
        :rtype: long
        """
        return self.data.find(self.END_OF_CENTRAL_DIRECTORY_SIGNATURE)

    def get_central_directory_start(self):
        """
        Nalezne ofset počátku sekce Central Directory.
        Podle specifikace PKZip je ofset vždy zapsán v sekci
        'End of the Central Directory' na ofsetu 16 až 20.

        :return: Ofset počátku sekce Central Directory
        :rtype: long
        """
        return struct.unpack("<L", self.data[self.end_of_central_directory + 16:self.end_of_central_directory + 20])[0]

    def get_local_header(self, cd_file_header_offset):
        """
        Nalezne ofset sekce Local File Header jednoho souboru.
        Podle dokumentace se ofset nachází v každé sekci File Header
        v Central Directory na ofsetu 0x2A - 0x2D (42 - 46).

        :param cd_file_header_offset: Ofset v APK kde začíná aktuální sekce File Header
        :type cd_file_header_offset: long
        :return: Ofset související sekce Local File Header
        :rtype: long
        """
        return struct.unpack("<L", self.data[cd_file_header_offset + 42:cd_file_header_offset + 46])[0]

    def get_next_file_header(self, search_from, search_to):
        """
        Nalezne následující sekci File Header v
        Central Directory v daném rozsahu ofsetů.

        :param search_from: Ofset, kde se začne hledat
        :param search_to: Ofset, kde se přestane hledat
        :return: Ofset následující sekce File Header v sekci Central Directory
        :type search_from: long
        :type search_to: long
        :rtype: long
        """
        return self.data.find(self.FILE_HEADER_SIGNATURE, search_from, search_to)
